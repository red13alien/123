Convars.SetValue( "rm_destroy_empty_weapon", 0 );
Convars.SetValue( "rd_hud_hide_clips", 1 );
Convars.SetValue( "asw_harvester_new", 0 );
Convars.SetValue( "rd_medgun_infinite_ammo", 1 );
Convars.SetValue( "sk_max_asw_ml", 0 );
Convars.SetValue( "sk_max_asw_p", 0 );
Convars.SetValue( "sk_max_asw_pdw", 0 );
Convars.SetValue( "sk_max_asw_deagle", 0 );
Convars.SetValue( "sk_max_asw_f", 0 );
Convars.SetValue( "sk_max_asw_r", 0 );
Convars.SetValue( "sk_max_asw_asg", 0 );
Convars.SetValue( "sk_max_asw_rg", 0 );
Convars.SetValue( "sk_max_asw_devastator", 0 );
Convars.SetValue( "sk_max_asw_gl", 0 );
Convars.SetValue( "sk_max_asw_tg", 0 );
Convars.SetValue( "sk_max_asw_ag", 0 );
Convars.SetValue( "sk_max_asw_sg", 0 );
Convars.SetValue( "sk_max_asw_hr", 0 );
Convars.SetValue( "sk_max_asw_sniper", 0 );
Convars.SetValue( "sk_max_asw_medrifle", 0 );
Convars.SetValue( "asw_sentry_infinite_ammo", 1 );
Convars.SetValue( "asw_alien_mining_laser_damage_scale", 10 );
Convars.SetValue( "rd_deagle_bigalien_dmg_scale", 1 );
Convars.SetValue( "asw_alien_burn_duration", 1.5 );
Convars.SetValue( "asw_fist_passive_damage_scale", 100 );
Convars.SetValue( "asw_skill_autogun_base", 50 );
Convars.SetValue( "asw_skill_vindicator_pellets_base", 25 );
Convars.SetValue( "asw_skill_accuracy_prifle_dmg_base", 75 );
Convars.SetValue( "asw_skill_accuracy_heavy_rifle_dmg_base", 95 );
Convars.SetValue( "asw_skill_accuracy_medrifle_dmg_base", 30 );
Convars.SetValue( "asw_skill_accuracy_railgun_dmg_base", 5000 );
Convars.SetValue( "asw_skill_accuracy_pistol_dmg_base", 50 );
Convars.SetValue( "asw_skill_accuracy_pdw_dmg_base", 30 );
Convars.SetValue( "asw_skill_accuracy_deagle_dmg_base", 300 );
Convars.SetValue( "asw_skill_engineering_welding_base", 99 );
Convars.SetValue( "asw_skill_engineering_sentry_base", 99 );
Convars.SetValue( "asw_cluster_grenade_child_fuse_max", 2 );
Convars.SetValue( "asw_skill_grenades_clusters_base", 5 );
Convars.SetValue( "asw_skill_grenades_cluster_dmg_step", 60 );
Convars.SetValue( "asw_cluster_grenade_fuse", 5 );
Convars.SetValue( "asw_cluster_grenade_radius_check_scale", 0.2 );
Convars.SetValue( "asw_night_vision_duration", 99999 );
Convars.SetValue( "asw_flare_launch_delay", 0.30 );
Convars.SetValue( "asw_flare_autoaim_radius", 600 );
Convars.SetValue( "asw_electrified_armor_duration", 30 );
Convars.SetValue( "asw_skill_drugs_base", 0 );
Convars.SetValue( "asw_skill_drugs_step", 0 );
Convars.SetValue( "asw_skill_mines_fires_base", 4 );
Convars.SetValue( "asw_skill_mines_fires_step", 0 );
Convars.SetValue( "asw_skill_healing_hps_base", 99 );
Convars.SetValue( "asw_skill_healing_hps_step", 99 );
Convars.SetValue( "asw_skill_mines_duration_base", 40 );
Convars.SetValue( "asw_skill_mines_duration_step", 0 );
Convars.SetValue( "asw_skill_grenades_smart_count_base", 999999 );
Convars.SetValue( "asw_skill_grenades_smart_interval_base", 0.8 );
Convars.SetValue( "asw_skill_grenades_hornet_count_base", 100 );
Convars.SetValue( "asw_skill_grenades_hornet_interval_base", 0.05 );
Convars.SetValue( "asw_knockdown_interval", 0 );
Convars.SetValue( "rd_drone_uber_model_scale", 2.3 );
Convars.SetValue( "rd_alien_instagib", 1 );
Convars.SetValue( "asw_queen_spit_radius", 2800 );
Convars.SetValue( "asw_queen_spit_autoaim_angle", 100 );
Convars.SetValue( "asw_queen_grabber_dmg", -10 );
Convars.SetValue( "asw_queen_grabber_health", 999 );
Convars.SetValue( "sk_asw_boomer_melee_damage_min", 20 );
Convars.SetValue( "sk_asw_boomer_melee_damage_max", 30 );
Convars.SetValue( "sk_asw_boomer_bomb_damage", 70 );
Convars.SetValue( "sk_asw_mortarbug_shell_damage", 70 );
Convars.SetValue( "asw_horde_interval_min", 5 );
Convars.SetValue( "asw_horde_interval_max", 10 );
Convars.SetValue( "asw_batch_interval", 3 );
Convars.SetValue( "asw_max_alien_batch", 3 );
Convars.SetValue( "asw_shaman_aim_ahead_time", 0 );
Convars.SetValue( "asw_shaman_health", 400 );
Convars.SetValue( "asw_boomer_health", 12000 );
Convars.SetValue( "rd_alien_speed_scale", 1.66 );
Convars.SetValue( "sk_antlionguard_health", 3000 );
Convars.SetValue( "asw_wanderer_override", 1 );
Convars.SetValue( "asw_harvester_max_critters", 10 );
Convars.SetValue( "asw_harvester_spawn_height", 1 );
Convars.SetValue( "asw_harvester_spawn_interval", 0.1 );
Convars.SetValue( "asw_buzzer_poison_duration", 4 );
Convars.SetValue( "sk_asw_buzzer_health", 650 );
Convars.SetValue( "asw_parasite_speedboost", 2 );
Convars.SetValue( "asw_melee_require_contact", 1 );
Convars.SetValue( "asw_shieldbug_knockdown_force", -10 );
Convars.SetValue( "asw_shieldbug_knockdown_lift", -10 );
Convars.SetValue( "asw_shieldbug_speedboost", 2.3 );
Convars.SetValue( "asw_shieldbug_force_defend", 2 );
Convars.SetValue( "asw_shieldbug_defending_speedboost", 2 );
Convars.SetValue( "sk_asw_parasite_infest_dmg_brutal", 320 );
Convars.SetValue( "sk_asw_parasite_infest_dmg_easy", 320 );
Convars.SetValue( "sk_asw_parasite_infest_dmg_hard", 320 );
Convars.SetValue( "sk_asw_parasite_infest_dmg_insane", 320 );
Convars.SetValue( "sk_asw_parasite_infest_dmg_normal", 320 );
Convars.SetValue( "sk_asw_buzzer_melee_interval", 0 );
Convars.SetValue( "sk_asw_buzzer_melee_dmg", 20 );
Convars.SetValue( "rd_killingspree_time_limit", 99999 );
Convars.SetValue( "asw_marine_death_cam_slowdown", 0 );
Convars.SetValue( "rd_override_allow_rotate_camera", 1 );
Convars.SetValue( "rd_firemine_target_marine", 1 );
Convars.SetValue( "asw_marine_fall_damage", 1 );
Convars.SetValue( "rd_biomass_ignite_from_explosions", 1 );
Convars.SetValue( "rd_hp_regen", 1 );
Convars.SetValue( "asw_marine_death_protection", 0 );
Convars.SetValue( "rm_health_regen_amount", 5 );
Convars.SetValue( "rm_health_regen_interval", 8 );
Convars.SetValue( "rd_mininglaser_slows_down", 0 );
Convars.SetValue( "asw_stun_grenade_time", 5 );
Convars.SetValue( "asw_alien_stunned_speed", 0.2 );
Convars.SetValue( "asw_marine_death_cam", 0 );
Convars.SetValue( "rd_bot_strong", 0 );
Convars.SetValue( "rd_carnage_scale", 6 );
Convars.SetValue( "asw_sentry_friendly_fire_scale", 0 );
Convars.SetValue( "asw_marine_burn_time_easy", 1 );
Convars.SetValue( "asw_marine_burn_time_hard", 1 );
Convars.SetValue( "asw_marine_burn_time_insane", 1 );
Convars.SetValue( "asw_marine_burn_time_normal", 1 );
Convars.SetValue( "asw_ranger_health", 4000 );
Convars.SetValue( "rd_notify_about_out_of_ammo", 0 );
Convars.SetValue( "rd_sentry_is_attacked_by_aliens", 0 );
Convars.SetValue( "rd_sentry_invincible", 1 );
Convars.SetValue( "rd_slowmo", 0 );
Convars.SetValue( "asw_skill_reloading_fast_base", 0 );
Convars.SetValue( "asw_skill_reloading_fast_step", 0 );
Convars.SetValue( "asw_skill_reloading_step", 0 );
Convars.SetValue( "asw_skill_reloading_base", 3 );
Convars.SetValue( "rd_extinguisher_dmg_amount", 0.1 );
Convars.SetValue( "rd_extinguisher_freeze_amount", 0.2 );
Convars.SetValue( "rd_fire_extinguisher_infinite", 1 );
Convars.SetValue( "rd_allow_revive", 0 );

infWeapon <- [
	"asw_weapon_rifle",
	"asw_weapon_vindicator",
	"asw_weapon_prifle",
	"asw_weapon_minigun",
	"asw_weapon_50calmg",
	"asw_weapon_autogun",
	"asw_weapon_deagle",
	"asw_weapon_devastator",
	"asw_weapon_flamer",
	"asw_weapon_mining_laser",
	"asw_weapon_pdw",
	"asw_weapon_pistol",
	"asw_weapon_ricochet",
	"asw_weapon_shotgun",
	"asw_weapon_tesla_gun",
	"asw_weapon_stim",
	"asw_weapon_sniper_rifle",
	"asw_weapon_medrifle",
	"asw_weapon_heavy_rifle",
	"asw_weapon_combat_rifle"
];

regenInterval <- {
	asw_weapon_tesla_trap=20
	asw_weapon_stim=0
	asw_weapon_heal_grenade=0
	asw_weapon_electrified_armor=30
	asw_weapon_hornet_barrage=0
	asw_weapon_grenades=0
	asw_weapon_mines=0
	asw_weapon_medical_satchel=20
	asw_weapon_medkit=15
	asw_weapon_laser_mines=20
	asw_weapon_freeze_grenades=15
	asw_weapon_flares=0
	asw_weapon_gas_grenades=0
}

ammoCount <- {
	asw_weapon_tesla_trap=3
	asw_weapon_stim=1
	asw_weapon_heal_grenade=3
	asw_weapon_electrified_armor=2
	asw_weapon_hornet_barrage=1
	asw_weapon_grenades=2
	asw_weapon_mines=3
	asw_weapon_medical_satchel=2
	asw_weapon_medkit=3
	asw_weapon_laser_mines=10
	asw_weapon_freeze_grenades=3
	asw_weapon_flares=1
	asw_weapon_gas_grenades=3
}

regenDelay <- {
	asw_weapon_tesla_trap=10
	asw_weapon_stim=30
	asw_weapon_heal_grenade=15
	asw_weapon_electrified_armor=30
	asw_weapon_hornet_barrage=30
	asw_weapon_grenades=60
	asw_weapon_mines=50
	asw_weapon_medical_satchel=20
	asw_weapon_medkit=30
	asw_weapon_laser_mines=20
	asw_weapon_freeze_grenades=15
	asw_weapon_flares=3
	asw_weapon_gas_grenades=50
}

damageTable <- {
	asw_weapon_shotgun=300
	asw_weapon_ricochet=75
	asw_weapon_prifle=0
	asw_weapon_devastator=20
	asw_weapon_rifle=75
	asw_weapon_combat_rifle=75
	asw_weapon_minigun=50
	asw_weapon_deagle=0
	asw_weapon_50calmg=90
	asw_weapon_vindicator=30
	asw_weapon_flamer=0
	asw_weapon_railgun=0
	asw_weapon_electrified_armor=200
	asw_weapon_tesla_trap=15
	asw_weapon_sniper_rifle=0
	asw_weapon_chainsaw=200
	asw_weapon_pistol=0
	asw_weapon_hornet_barrage=0
	asw_weapon_smart_bomb=0
	asw_weapon_tesla_gun=0
	asw_weapon_pdw=0
	asw_weapon_grenades=1400
	asw_weapon_mining_laser=0
	asw_weapon_autogun=0
	asw_weapon_medrifle=0
	asw_weapon_heavy_rifle=0
}

friendlyDamageTable <- {
	asw_weapon_shotgun=10
	asw_weapon_ricochet=10
	asw_weapon_prifle=10
	asw_weapon_devastator=2
	asw_weapon_rifle=10
	asw_weapon_combat_rifle=10
	asw_weapon_minigun=3
	asw_weapon_deagle=20
	asw_weapon_50calmg=20
	asw_weapon_vindicator=3
	asw_weapon_flamer=0
	asw_weapon_railgun=40
	asw_weapon_electrified_armor=0
	asw_weapon_tesla_trap=0
	asw_weapon_sniper_rifle=30
	asw_weapon_chainsaw=10
	asw_weapon_pistol=5
	asw_weapon_hornet_barrage=0
	asw_weapon_smart_bomb=0
	asw_weapon_tesla_gun=0
	asw_weapon_pdw=6
	asw_weapon_grenades=0
	asw_weapon_mining_laser=20
	asw_weapon_autogun=10
	asw_weapon_medrifle=5
	asw_weapon_heavy_rifle=10
}

backfireDamageTable <- {
	asw_weapon_shotgun=5
	asw_weapon_ricochet=5
	asw_weapon_prifle=5
	asw_weapon_devastator=2
	asw_weapon_rifle=5
	asw_weapon_combat_rifle=5
	asw_weapon_minigun=5
	asw_weapon_deagle=20
	asw_weapon_50calmg=20
	asw_weapon_vindicator=2
	asw_weapon_flamer=0
	asw_weapon_railgun=70
	asw_weapon_electrified_armor=0
	asw_weapon_tesla_trap=0
	asw_weapon_sniper_rifle=30
	asw_weapon_chainsaw=10
	asw_weapon_pistol=5
	asw_weapon_hornet_barrage=0
	asw_weapon_smart_bomb=0
	asw_weapon_tesla_gun=0
	asw_weapon_pdw=5
	asw_weapon_grenades=0
	asw_weapon_mining_laser=15
	asw_weapon_autogun=10
	asw_weapon_medrifle=5
	asw_weapon_heavy_rifle=5
}

nextRefillTick1 <- {};
nextRefillTick2 <- {};
lastClip1 <- {};
lastClip2 <- {};

timeBetweenRefill1 <- 0.1;
timeBetweenRefill2 <- 5;
timeBetweenInverse1 <- 75;
timeBetweenInverse2 <- 5;
timeAfterShoot1 <- 5;
timeAfterShoot2 <- 10;
singleClipPenalty <- 0.55;
noClipPenalty <- 4;

ammoEntities <- [
	"asw_ammo_drop",
	"asw_ammo_rifle",
	"asw_ammo_autogun",
	"asw_ammo_shotgun",
	"asw_ammo_vindicator",
	"asw_ammo_flamer",
	"asw_ammo_pistol",
	"asw_ammo_mining_laser",
	"asw_ammo_railgun",
	"asw_ammo_chainsaw",
	"asw_ammo_pdw",
	"asw_weapon_ammo_satchel",
	"asw_pickup_ammo_satchel",
	"asw_weapon_blink",
	"asw_weapon_t75",
	"asw_weapon_jump_jet"	
];

local target = Entities.CreateByClassname("info_target");
target.PrecacheModel("models/swarm/harvester/Harvester.mdl");

if ( Convars.GetStr("asw_marine_ff_absorption") != "0" )
{
	Convars.SetValue( "asw_skill_hacking_speed_base", 99 );
	Convars.SetValue( "asw_simple_hacking", 1 );
} else Convars.SetValue( "rd_marine_ff_fist", 1 );

function InjectThink(scrEnt, thinkFunc) //https://developer.valvesoftware.com/wiki/L4D2_EMS/Appendix:_Functions
{
   scrEnt.ValidateScriptScope();
   local scrScope = scrEnt.GetScriptScope();
   scrScope.InjectedThink <- thinkFunc;
   AddThinkToEnt( scrEnt, "InjectedThink" );
}
// and then you could call it like so to have a spawned entity call a common think passing itself as an argument
// InjectThink( myEnt, @() g_MapScript.InjectedThink(self))
// or of course whatever function you want/local thing, etc

function IsMarineInfested() //destroy parasite prop
{
	local isInfested = NetProps.GetPropFloat( hVictim, "m_fInfestedTime" );
	if (isInfested == 0)
		self.Destroy();
}

function RotateToMarineNeck() //rotate parasite
{
	self.SetLocalAngles(40, 90, 0);
	self.SetLocalOrigin(Vector(0, -3, 0));
	self.DisconnectOutput("OnUser1", "RotateToMarineNeck");
}

function OnGameEvent_entity_killed(params)
{
	local victim = EntIndexToHScript( params["entindex_killed"] );
	
	if ( victim.GetName() == "asw_4fun_buzzer" ){
		victim.StopSound("d1_town.LargeFireLoop");
		victim.StopSound("d1_town.LargeFireLoop");
	}
}

function OnGameEvent_sentry_complete(params)
{
	local sentry = EntIndexToHScript( params["entindex"] );
	sentry.SetCollisionGroup(24);
	sentry.SetSize( Vector(0,0,0), Vector(0,0,0));
}

function OnGameEvent_sentry_start_building(params)
{
	local sentry = EntIndexToHScript( params["entindex"] );
	sentry.SetCollisionGroup(24);
	sentry.SetSize( Vector(0,0,0), Vector(0,0,0));
}

function OnGameEvent_weapon_reload_finish(params)
{
	local marine = EntIndexToHScript( params["marine"] );
	local hActiveWeapon = NetProps.GetPropEntity(marine, "m_hActiveWeapon");
	if (hActiveWeapon && hActiveWeapon.GetClassname() == "asw_weapon_grenade_launcher")
		hActiveWeapon.SetClip1(14);
}

function SpawnChanger(AName, AClass, Health)
{
	local alien = null;
	while ( ( alien = Entities.FindByClassname( alien, AName ) ) != null ){
		if (alien.GetName() != ""){
			alien.SetMaxHealth(alien.GetHealth()+Health);
			alien.SetHealth(alien.GetHealth()+Health);
			EntFireByHandle(alien, "Color", (RandomInt(0, 255)).tostring() + " " + (RandomInt(0, 255)).tostring() + " " + (RandomInt(0, 255)).tostring(), 0, self, self);
		} else {
			local spawner = Entities.CreateByClassname("asw_spawner");
			spawner.SetOrigin(alien.GetOrigin() + Vector (0, 0, 10));
			spawner.__KeyValueFromString("AlienClass", AClass);
			spawner.__KeyValueFromString("AlienOrders", "3");
			spawner.__KeyValueFromString("MaxLiveAliens", "1");
			spawner.__KeyValueFromString("SpawnerState", "1");
			spawner.__KeyValueFromString("ClearCheck", "0");
			spawner.__KeyValueFromString("SpawnIfMarinesAreNear", "1");
			spawner.__KeyValueFromString("NumAliens", "1");
			spawner.Spawn();
			DoEntFire("!self", "Startspawner", "", 0, null, spawner);
			DoEntFire("!self", "Kill", "", 2, null, spawner);
			alien.Destroy();
		}
	}
}

function SpawnerChanger(AlnCLASS, VScript, HealthBonus, SpeedScale, SizeScale, Min, Max )
{
	if (hSpawner.GetKeyValue("AlienClass") == AlnCLASS){
		if (VScript != 0)
			hSpawner.__KeyValueFromString("alien_vscripts", VScript);
		if (HealthBonus != 0)
			hSpawner.__KeyValueFromString("healthbonussp", HealthBonus);
		if (SpeedScale != 0)
			hSpawner.__KeyValueFromString("speedscalesp", SpeedScale);
		if (SizeScale != 0)
			hSpawner.__KeyValueFromString("sizescalesp", RandomFloat( Min, Max ).tostring());
	}
}

function OnMissionStart()
{
	local timer = Entities.CreateByClassname("logic_timer");
	timer.__KeyValueFromFloat("RefireTime", 0.3);
	DoEntFire("!self", "Disable", "", 0, null, timer);
	timer.ValidateScriptScope();
	timer.GetScriptScope().find_gl_func <- function()
	{
		local find_gl = null;
		while ( ( find_gl = Entities.FindByClassname( find_gl, "asw_weapon_grenade_launcher" ) ) != null )
			find_gl.SetClip1(14);
		self.DisconnectOutput("OnTimer", "find_gl_func");
		self.Destroy();	
	}
	timer.ConnectOutput("OnTimer", "find_gl_func");
	DoEntFire("!self", "Enable", "", 0, null, timer);
}

SpawnChanger("asw_ranger", "10", 4000);
SpawnChanger("asw_boomer", "9", 20000);
SpawnChanger("asw_harvester", "6", 4000);
SpawnChanger("asw_mortarbug", "11", 4000);
SpawnChanger("asw_shieldbug", "3", 10000);

hSpawner <- null;
while((hSpawner = Entities.FindByClassname(hSpawner, "asw_spawner")) != null){
	SpawnerChanger("0", 0, 0, 0, 1, 1.3, 1.5 );
	SpawnerChanger("11", "4fun_mortar.nut", "4000",0, 1, 1.8, 2.2 );
	SpawnerChanger("6", "4fun_harvester.nut", "4000", 0, 1, 1.5, 3 );
	SpawnerChanger("9", "4fun_antlion_boomer.nut", "20000", "1.5", 1, 1.4, 1.6 );
	SpawnerChanger("3", "4fun_shield.nut", "10000", 0, 1, 1.3, 1.5 );
	SpawnerChanger("2", 0, 0, 0, 1, 0.6, 1.2 );
	
	if (GetMapName() == "rd-lan2_sewer" || GetMapName() == "rd-lan1_bridge" )
		SpawnerChanger("5", 0, "1600", "0.3", 1, 2.1, 2.6 );
}

if (GetMapName() == "rd-lan2_sewer" )
{
	Convars.SetValue( "rd_carnage_scale", 3 );
	Convars.SetValue( "asw_batch_interval", 3 );
	Convars.SetValue( "asw_max_alien_batch", 1 );
}

if (GetMapName() == "rd-lan3_maintenance" )
{
	Convars.SetValue( "asw_horde_interval_min", 30 );
	Convars.SetValue( "asw_horde_interval_max", 60 );
}

if (GetMapName() == "rd-lan1_bridge" )
{
	Convars.SetValue( "rd_carnage_scale", 1 );
}

function OnTakeDamage_Alive_Any( victim, inflictor, attacker, weapon, damage, damageType, ammoName )
{
	if (inflictor != null && inflictor.GetClassname() == "asw_missile_round" && inflictor.GetOwner().GetClassname() == "asw_ranger"){
		if (victim != null && victim.GetClassname() == "asw_marine"){
			victim.TakeDamage(10, 131072, attacker); //do buzzer poison damage
			if ( Convars.GetStr("rd_challenge") == "4fun" ){
				victim.BecomeInfested(); //infest marine
				parasiteProp <- CreateProp("prop_dynamic", victim.GetOrigin(), "models/aliens/parasite/parasite.mdl", 17); //create parasite like in default game, but with one position
				parasiteProp.SetOwner(victim);
				parasiteProp.ValidateScriptScope();
				local parasitePropScope = parasiteProp.GetScriptScope();
				parasitePropScope.RotateToMarineNeck <- RotateToMarineNeck;
				parasitePropScope.hVictim <- victim;
				DoEntFire("!self", "SetParent", "!activator", 0,  victim, parasiteProp);
				DoEntFire("!self", "SetParentAttachment", "anim_attachment_head", 0,  victim, parasiteProp);
				DoEntFire("!self", "SetDefaultAnimation", "ragdoll", 0,  self, parasiteProp);
				DoEntFire("!self", "SetAnimation", "ragdoll", 0,  self, parasiteProp);
				DoEntFire("!self", "DisableShadow", "", 0,  self, parasiteProp);
				parasiteProp.ConnectOutput("OnUser1", "RotateToMarineNeck");
				DoEntFire("!self", "FireUser1", "", 0,  self, parasiteProp);
				InjectThink( parasiteProp, IsMarineInfested );
			}
		}
	}
	
	local dam = 0;

	if (weapon != null && (weapon.GetClassname() in damageTable)){
		damage += damageTable[weapon.GetClassname()];
		if ( victim != null && victim.GetClassname() == "asw_marine" ){
			if (Convars.GetFloat("asw_marine_ff_absorption").tointeger() == 0){
				damage = 0;
				dam = backfireDamageTable[weapon.GetClassname()];
			}
			else damage = friendlyDamageTable[weapon.GetClassname()];
		}
	}
	
	if(weapon != null){
		switch(weapon.GetClassname()) {
			case "asw_weapon_prifle":	
				if ( victim != null && victim == attacker )
					damage = 3;
				break;
			case "asw_weapon_rifle":
				if (inflictor != null && inflictor.GetClassname() == "asw_rifle_grenade" && inflictor.GetOwner() == attacker){
					if (victim != null){
						if (victim.GetClassname() == "asw_marine")
							damage = 40;
						else damage += 1000;
					}
				}
				break;
			case "asw_weapon_deagle":
				local explosion = Entities.CreateByClassname("env_explosion");
				explosion.__KeyValueFromInt("spawnflags", 65);         
				explosion.SetOrigin(victim.GetOrigin() + Vector(0, 0, 10));      
				DoEntFire("!self", "Explode", "", 0, null, explosion);
				DoEntFire("!self", "Kill", "", 0.5, null, explosion);
				if ( victim != null && victim.GetClassname() == "asw_ranger" )
					damage = 300;
				local hNearEntitie = null;
				while ( ( hNearEntitie = Entities.FindInSphere( hNearEntitie, victim.GetOrigin(), 15 ) ) != null ){
					if ( hNearEntitie.IsAlien() && hNearEntitie != victim )
						hNearEntitie.TakeDamage( 80, 4098, null );
				}
				break;
			case "asw_weapon_shotgun":
				if ( attacker != null && attacker.GetClassname() == "asw_marine" ){
					if ( victim != null && victim.GetClassname() != "asw_marine"){
						local explosion = Entities.CreateByClassname("env_explosion");
						explosion.__KeyValueFromInt("spawnflags", 65);         
						explosion.SetOrigin(victim.GetOrigin() + Vector(0, 0, 10));      
						DoEntFire("!self", "Explode", "", 0, null, explosion);
						DoEntFire("!self", "Kill", "", 0.5, null, explosion);
					
						local nearTarget = null;
						local radius = 100;
						
						while((nearTarget = Entities.FindByClassnameWithin(nearTarget, "asw_drone", victim.GetOrigin(), radius)) != null){
							local killExplosion = Entities.CreateByClassname("env_explosion");
							killExplosion.__KeyValueFromInt("iMagnitude", 80);
							killExplosion.__KeyValueFromInt("iRadiusOverride", 16);
							killExplosion.__KeyValueFromInt("spawnflags", 8060);               
							killExplosion.SetOrigin(nearTarget.GetOrigin() + Vector(0, 0, 10));              
							DoEntFire("!self", "Explode", "", 0, null, killExplosion);
							DoEntFire("!self", "Kill", "", 0.5, null, killExplosion);
						}
						
						while((nearTarget = Entities.FindByClassnameWithin(nearTarget, "asw_drone_jumper", victim.GetOrigin(), radius)) != null){
							local killExplosion = Entities.CreateByClassname("env_explosion");
							killExplosion.__KeyValueFromInt("iMagnitude", 80);
							killExplosion.__KeyValueFromInt("iRadiusOverride", 16);
							killExplosion.__KeyValueFromInt("spawnflags", 8060);               
							killExplosion.SetOrigin(nearTarget.GetOrigin() + Vector(0, 0, 10));              
							DoEntFire("!self", "Explode", "", 0, null, killExplosion);
							DoEntFire("!self", "Kill", "", 0.5, null, killExplosion);
						}
					}
				}
				break;
			case "asw_weapon_flamer":
				dam = 0;
				if ( victim != null && victim.GetClassname() == "asw_marine" ){
					if (victim.GetHealth() <= victim.GetMaxHealth()){
						victim.SetHealth(victim.GetHealth() + (victim.GetMaxHealth()/40));
						if (attacker.GetHealth() <= attacker.GetMaxHealth())
							attacker.SetHealth(attacker.GetHealth() + (attacker.GetMaxHealth()/40));
					}
				} else if ( victim != null )
					damage = 1;
				break;
			case "asw_weapon_sniper_rifle":	
				if ( attacker != null && attacker.GetClassname() == "asw_marine" ){
					if ( victim != null && victim.GetClassname() != "asw_marine"){
						local explosion = Entities.CreateByClassname("env_explosion");
						explosion.__KeyValueFromInt("spawnflags", 65);         
						explosion.SetOrigin(victim.GetOrigin() + Vector(0, 0, 10));      
						DoEntFire("!self", "Explode", "", 0, null, explosion);
						DoEntFire("!self", "Kill", "", 0.5, null, explosion);
						local A = attacker.GetOrigin();
						local B = victim.GetOrigin();
						local fDistance = (A - B).Length();
						local iDmg = 5;
						if (fDistance >= 500.0){
							damage = victim.GetHealth();
							iDmg = pow(iDmg, 10);
						} else if (fDistance < 500.0 && fDistance >= 400.0){
							damage = victim.GetHealth();
							iDmg = 40;
						} else if (fDistance < 400.0)
							damage = fDistance;
						local hNearEntitie = null;
						while ( ( hNearEntitie = Entities.FindInSphere( hNearEntitie, victim.GetOrigin(), 180 ) ) != null ){
							if ( hNearEntitie.IsAlien() && hNearEntitie != victim )
								hNearEntitie.TakeDamage( iDmg, 4098, null );
						}  			
					}
				}
				break;
			case "asw_weapon_chainsaw":
				if (attacker.GetHealth() <= attacker.GetMaxHealth())
					attacker.SetHealth(attacker.GetHealth() + (attacker.GetMaxHealth()/80));
				break;
			case "asw_weapon_grenades":
				if (victim.GetHealth() <= victim.GetMaxHealth())
					victim.SetHealth(victim.GetHealth() + (victim.GetMaxHealth()/4));
				break;
			case "asw_weapon_vindicator":
				if ( victim != null && victim.GetClassname() == "asw_marine" && victim == attacker )
					damage = 20;
				break;
			case "asw_weapon_grenade_launcher":
				if ( victim != null && victim.GetClassname() == "asw_marine" && victim != attacker ){
					if (Convars.GetFloat("asw_marine_ff_absorption").tointeger() == 0){
						damage = 0;
						dam = 90;
					} else damage = 30;
				}
				break;
			case "asw_weapon_tesla_gun":
				if (victim != null && victim.GetClassname() != "asw_marine"){
					local scale = 0;
					if ( victim.GetName() == "asw_4fun_drone_giant" )
						scale = 0.3; else
						scale = 1;
					local nearTarget = null;
					local radius = 60;
					while((nearTarget = Entities.FindByClassnameWithin(nearTarget, "asw_drone", victim.GetOrigin(), radius)) != null){
						DoEntFire("!self", "AddOutput", "speedscale -1", 0, null, nearTarget);
						DoEntFire("!self", "AddOutput", "speedscale " + scale.tostring(), 1, null, nearTarget);	
					}
					if (victim.GetClassname() == "asw_drone"){
						DoEntFire("!self", "AddOutput", "speedscale -1", 0, null, victim);
						DoEntFire("!self", "AddOutput", "speedscale " + scale.tostring(), 5, null, victim);
					}
				}
				damage = victim.GetHealth()/20;
				break;
			case "asw_marine":
				if (attacker != null && attacker.GetClassname() == "asw_marine"){
					if (inflictor != null && inflictor.GetClassname() == "asw_marine"){
						if (victim != null && victim.GetClassname() == "asw_marine")
							damage = victim.GetMaxHealth()/16;
					}
				}
				break;
			default: break;
		}
	}

	if (Convars.GetFloat("asw_marine_ff_absorption").tointeger() == 0){
		if ( attacker != null && attacker.GetClassname() == "asw_marine" ){
			if ( victim != null && victim.GetClassname() == "asw_marine" && victim != attacker ){
				if (inflictor != null && inflictor.GetClassname() != "asw_burning" 
					&& inflictor.GetClassname() != "asw_sentry_top_machinegun" 
					&& inflictor.GetClassname() != "asw_barrel_explosive"){
					if (weapon.GetClassname() != "asw_sentry_top_cannon"){
						if (attacker.GetHealth() - dam <= 0){
							local explosion = Entities.CreateByClassname("env_explosion");
							explosion.__KeyValueFromInt("iMagnitude", 20);
							explosion.__KeyValueFromInt("spawnflags", 1916);						
							explosion.SetOrigin(attacker.GetOrigin() + Vector(0, 0, 37));							
							DoEntFire("!self", "Explode", "", 0, null, explosion);
							DoEntFire("!self", "Kill", "", 0.5, null, explosion);
						}
						else attacker.SetHealth(attacker.GetHealth() - dam);
						dam = 0;
					}
				} else if (inflictor != null && inflictor.GetClassname() == "asw_barrel_explosive")
					damage = 0;
			}
		}
	}

	return damage;
}
g_ModeScript.OnTakeDamage_Alive_Any <- OnTakeDamage_Alive_Any;

function Update()
{
	foreach ( classname in ammoEntities ){
		ammo <- null;
		while ( ( ammo = Entities.FindByClassname( ammo, classname ) ) != null ){
			if ( !(GetMapName() == "rd-ad4_forbidden_outpost" && classname == "asw_weapon_jump_jet") )
				ammo.Destroy();
		}
	}

	if (VoteStarted != 0 && VoteStarted + 30 <= Time()){
		Reason = null;
		UserID = {};
		VoteStarted = 0;
		Voted = 0;
		Vote = null;
		PlayerCount = 0;
	}
	
	local hDoor = null;
	while ( (hDoor = Entities.FindByClassname( hDoor, "asw_door" )) != null ){
		if (hDoor.GetHealth() <= 0)
			DoEntFire("!self", "Kill", "", 2, null, hDoor);
	}
	
	local minDelay = 0.2;
	local marine = null;
	while ( (marine = Entities.FindByClassname( marine, "asw_marine" )) != null ){
        for (local weapon = marine.FirstMoveChild(); weapon != null; weapon = weapon.NextMovePeer()){
			if ( !( "GetMaxClip1" in weapon ) )
				continue;
			
			local maxClip1 = weapon.GetMaxClip1();
			foreach (IWT in infWeapon){
				if (weapon.GetClassname() == IWT && weapon.Clip1() < maxClip1)
					weapon.SetClip1(maxClip1);
			}

			if ((weapon.GetClassname() == "asw_weapon_railgun" || weapon.GetClassname() == "asw_weapon_grenade_launcher") && weapon.GetClips() < 2)
				weapon.SetClips(2);

            if (weapon.GetClassname() in regenDelay){
				timeBetweenInverse1 = regenInterval[weapon.GetClassname()];
				timeAfterShoot1 = regenDelay[weapon.GetClassname()];
				
				local clips1 = weapon.GetMaxAmmo1() / maxClip1;
				if ( clips1 < noClipPenalty ){
					if (weapon.GetClassname() in ammoCount)
						maxClip1 = ammoCount[weapon.GetClassname()];
					else maxClip1 = ceil( maxClip1 * ( 1 - singleClipPenalty / clips1 ) );
				}			
				
                if ( weapon.Clip1() > maxClip1 )
                    weapon.SetClip1( maxClip1 );
 
                if ( !( weapon.entindex() in nextRefillTick1 ) ){
                    nextRefillTick1[weapon.entindex()] <- Time();
                    lastClip1[weapon.entindex()] <- weapon.Clip1();
                    continue;
                }
 
                if ( weapon.Clip1() != lastClip1[weapon.entindex()] ){
                    lastClip1[weapon.entindex()] = weapon.Clip1();
                    nextRefillTick1[weapon.entindex()] = Time() + timeAfterShoot1 + timeBetweenInverse1 / weapon.GetMaxAmmo1();
                }
				
                if ( nextRefillTick1[weapon.entindex()] <= Time() && weapon.Clip1() < maxClip1 ){
                    weapon.SetClip1( weapon.Clip1() + 1 );
                    lastClip1[weapon.entindex()] = weapon.Clip1();
                    delay <- timeBetweenRefill1 + timeBetweenInverse1 / weapon.GetMaxAmmo1();
                    nextRefillTick1[weapon.entindex()] = Time() + delay;
                    if ( delay < minDelay )
                        minDelay = delay;
                }
            }
			
			if ( weapon.GetClassname() == "asw_weapon_rifle"
				|| weapon.GetClassname() == "asw_weapon_vindicator" 
				|| weapon.GetClassname() == "asw_weapon_prifle" 
				|| weapon.GetClassname() == "asw_weapon_combat_rifle"
				|| weapon.GetClassname() == "asw_weapon_heavy_rifle" ){
			
                if ( !( weapon.entindex() in nextRefillTick2 ) ){
                    nextRefillTick2[weapon.entindex()] <- Time();
                    lastClip2[weapon.entindex()] <- weapon.Clip2();
                    continue;
                }			
			
				if ( weapon.GetMaxClip2() <= 0 )
					continue;

				if ( weapon.Clip2() != lastClip2[weapon.entindex()] ){
					lastClip2[weapon.entindex()] = weapon.Clip2();
					nextRefillTick2[weapon.entindex()] = Time() + timeAfterShoot2 + timeBetweenInverse2 / weapon.GetMaxAmmo2();
				}

				if ( nextRefillTick2[weapon.entindex()] <= Time() && weapon.Clip2() < weapon.GetDefaultClip2() ){
					weapon.SetClip2( weapon.Clip2() + 1 );
					lastClip2[weapon.entindex()] = weapon.Clip2();
					delay <- timeBetweenRefill2 + timeBetweenInverse2 / weapon.GetMaxAmmo2();
					nextRefillTick2[weapon.entindex()] = Time() + delay;
					if ( delay < minDelay )
						minDelay = delay;
				}		
			}
        }
    }

	timeBetweenInverse1 = 75;
	timeAfterShoot1 = 5;
	return minDelay;
}

UserID <- {};
VoteStarted <- 0;
Voted <- 0;
PlayerCount <- 0;
Vote <- null;
Reason <- null;
function OnGameEvent_player_say(params)
{
	foreach(index, value in params)
	{
		printl(index + " <-index" + value + " <-value");
	}
	
	if (!("text" in params)) //stolen :)
		return;
	else if (params["text"] == null)
		return;
	
	local ID = EntIndexToHScript( params["userid"] );
	//printl(ID);
	if (ID == null)
		ID = 1;
	//printl(ID);

	local player = null;
	while((player = Entities.FindByClassname(player, "player")) != null)
		PlayerCount += 1;
		
	switch ((params["text"]).tolower()){
		case "start_vote_carnage_1":
			if (ID == 1){
				local player = null;
				while((player = Entities.FindByClassname(player, "player")) != null)
					ClientPrint(player, 3, "Carnage scale set to 1");
				Convars.SetValue("rd_carnage_scale", 1);
				ID = 0;
				return;
			} else if (VoteStarted == 0){
				VoteStarted = Time();
				Vote = 1;
				Reason = "Carnage";
			}
			break;
		case "start_vote_carnage_2":
			if (ID == 1){
				local player = null;
				while((player = Entities.FindByClassname(player, "player")) != null)
					ClientPrint(player, 3, "Carnage scale set to 2");
				Convars.SetValue("rd_carnage_scale", 2);
				ID = 0;
				return;
			} else if (VoteStarted == 0){
				VoteStarted = Time();
				Vote = 2;
				Reason = "Carnage";
			}
			break;
		case "start_vote_carnage_3":
			if (ID == 1){
				local player = null;
				while((player = Entities.FindByClassname(player, "player")) != null)
					ClientPrint(player, 3, "Carnage scale set to 3");
				Convars.SetValue("rd_carnage_scale", 3);
				ID = 0;
				return;
			} else if (VoteStarted == 0){
				VoteStarted = Time();
				Vote = 3;
				Reason = "Carnage";
			}
			break;
		case "start_vote_carnage_4":
			if (ID == 1){
				local player = null;
				while((player = Entities.FindByClassname(player, "player")) != null)
					ClientPrint(player, 3, "Carnage scale set to 4");
				Convars.SetValue("rd_carnage_scale", 4);
				ID = 0;
				return;
			} else if (VoteStarted == 0){
				VoteStarted = Time();
				Vote = 4;
				Reason = "Carnage";
			}
			break;
		case "start_vote_carnage_5":
			if (ID == 1){
				local player = null;
				while((player = Entities.FindByClassname(player, "player")) != null)
					ClientPrint(player, 3, "Carnage scale set to 5");
				Convars.SetValue("rd_carnage_scale", 5);
				ID = 0;
				return;
			} else if (VoteStarted == 0){
				VoteStarted = Time();
				Vote = 5;
				Reason = "Carnage";
			}
			break;
		case "start_vote_carnage_6":
			if (ID == 1){
				local player = null;
				while((player = Entities.FindByClassname(player, "player")) != null)
					ClientPrint(player, 3, "Carnage scale set to 6");
				Convars.SetValue("rd_carnage_scale", 6);
				ID = 0;
				return;
			} else if (VoteStarted == 0){
				VoteStarted = Time();
				Vote = 6;
				Reason = "Carnage";
			}
			break;
		case "start_vote_backfire_on":
			if (ID == 1){
				local player = null;
				while((player = Entities.FindByClassname(player, "player")) != null)
					ClientPrint(player, 3, "Backfire set to 1");
				Convars.SetValue("asw_marine_ff_absorption", 0);
				Convars.SetValue( "rd_marine_ff_fist", 1 );
				ID = 0;
				return;
			} else if (VoteStarted == 0){
				VoteStarted = Time();
				Vote = 0;
				Reason = "Backfire";
			}
			break;
		case "start_vote_backfire_off":
			if (ID == 1){
				local player = null;
				while((player = Entities.FindByClassname(player, "player")) != null)
					ClientPrint(player, 3, "Backfire set to 0");
				Convars.SetValue("asw_marine_ff_absorption", 1);
				Convars.SetValue( "rd_marine_ff_fist", 0 );
				ID = 0;
				return;
			} else if (VoteStarted == 0){
				VoteStarted = Time();
				Vote = 1;
				Reason = "Backfire";
			}
			break;
		case "start_vote_simple_hack_on":
			if (ID == 1){
				local player = null;
				while((player = Entities.FindByClassname(player, "player")) != null)
					ClientPrint(player, 3, "Simple hack set to 1");
				Convars.SetValue( "asw_skill_hacking_speed_base", 99 );
				Convars.SetValue( "asw_simple_hacking", 1 );
				ID = 0;
				return;
			} else if (VoteStarted == 0){
				VoteStarted = Time();
				Vote = 1;
				Reason = "Simple";
			}
			break;
		case "start_vote_simple_hack_off":
			if (ID == 1){
				local player = null;
				while((player = Entities.FindByClassname(player, "player")) != null)
					ClientPrint(player, 3, "Simple hack set to 0");
				Convars.SetValue( "asw_skill_hacking_speed_base", 2 );
				Convars.SetValue( "asw_simple_hacking", 0 );
				ID = 0;
				return;
			} else if (VoteStarted == 0){
				VoteStarted = Time();
				Vote = 0;
				Reason = "Simple";
			}
			break;
		case "start_vote_revive_on":
			if (ID == 1){
				local player = null;
				while((player = Entities.FindByClassname(player, "player")) != null)
					ClientPrint(player, 3, "Revive set to 1");
				Convars.SetValue( "rd_allow_revive", 1 );
				ID = 0;
				return;
			} else if (VoteStarted == 0){
				VoteStarted = Time();
				Vote = 1;
				Reason = "Revive";
			}
			break;
		case "start_vote_revive_off":
			if (ID == 1){
				local player = null;
				while((player = Entities.FindByClassname(player, "player")) != null)
					ClientPrint(player, 3, "Revive set to 0");
				Convars.SetValue( "rd_allow_revive", 1 );
				ID = 0;
				return;
			} else if (VoteStarted == 0){
				VoteStarted = Time();
				Vote = 0;
				Reason = "Revive";
			}
			break;
		case "+":
			if (VoteStarted + 30 >= Time() && !UserID.rawin(ID)){
				Voted += 1;
				ShowMessage(Voted + " of " + PlayerCount + " voted");
				UserID[ID] <- ID;
				if ((PlayerCount >= 2 && PlayerCount/Voted <= 2) || (PlayerCount <= 2 && Voted == PlayerCount)){
					if (Reason == "Carnage"){
						ShowMessage("Carnage scale set to " + Vote);
						Convars.SetValue("rd_carnage_scale", Vote);
					} else if (Reason == "Backfire"){
						Convars.SetValue("asw_marine_ff_absorption", Vote);
						Convars.SetValue( "rd_marine_ff_fist", !Vote );
						ShowMessage("Backfire set to " + !Vote);
					} else if (Reason == "Simple"){
						Convars.SetValue( "asw_simple_hacking", Vote );
						ShowMessage("Simple hack set to " + Vote);
						if (Vote)
							Vote = 99;
						else Vote = 2;
						Convars.SetValue( "asw_skill_hacking_speed_base", Vote );
					} else if (Reason == "Revive"){
						ShowMessage("Revive set to " + Vote);
						Convars.SetValue( "rd_allow_revive", Vote );
					}
					Reason = null;
					UserID = {};
					VoteStarted = 0;
					Voted = 0;
					Vote = null;
					PlayerCount = 0;
				}
			}
			break;
		default: break;
	}
}